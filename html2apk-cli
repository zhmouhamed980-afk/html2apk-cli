#!/usr/bin/env python3
import argparse
import os
import shutil
import subprocess
import sys
import json
import tty
import termios
import xml.etree.ElementTree as ET
from pathlib import Path

class C:
    HEADER  = '\033[95m'
    BLUE    = '\033[94m'
    CYAN    = '\033[96m'
    GREEN   = '\033[92m'
    YELLOW  = '\033[93m'
    RED     = '\033[91m'
    RESET   = '\033[0m'
    BOLD    = '\033[1m'
    DIM     = '\033[2m'

def clr(text, *colors):
    return ''.join(colors) + str(text) + C.RESET

def log(msg, color=C.BLUE):  print(clr(f"[*] {msg}", C.BOLD, color))
def ok(msg):                  print(clr(f"[âœ“] {msg}", C.BOLD, C.GREEN))
def warn(msg):                print(clr(f"[!] {msg}", C.BOLD, C.YELLOW))
def err(msg):                 print(clr(f"[âœ—] {msg}", C.BOLD, C.RED)); sys.exit(1)

PERMISSIONS = [
    ("storage",          "ğŸ“ Storage",             "Read & write files to external storage",
     ["android.permission.READ_EXTERNAL_STORAGE","android.permission.WRITE_EXTERNAL_STORAGE"],
     "cordova-plugin-file"),
    ("manage-storage",   "ğŸ“‚ Manage Storage",      "Full storage access â€” any folder (Android 11+)",
     ["android.permission.MANAGE_EXTERNAL_STORAGE"],
     "cordova-plugin-file"),
    ("camera",           "ğŸ“· Camera",              "Take photos and record video",
     ["android.permission.CAMERA"],
     "cordova-plugin-camera"),
    ("microphone",       "ğŸ¤ Microphone",          "Record audio",
     ["android.permission.RECORD_AUDIO"],
     "cordova-plugin-media"),
    ("media-images",     "ğŸ–¼  Media Images",        "Read images from gallery (Android 13+)",
     ["android.permission.READ_MEDIA_IMAGES"],
     "cordova-plugin-file"),
    ("media-video",      "ğŸ¬ Media Video",         "Read videos from gallery (Android 13+)",
     ["android.permission.READ_MEDIA_VIDEO"],
     "cordova-plugin-file"),
    ("media-audio",      "ğŸµ Media Audio",         "Read audio files (Android 13+)",
     ["android.permission.READ_MEDIA_AUDIO"],
     "cordova-plugin-file"),
    ("location",         "ğŸ“ Location",            "GPS precise & approximate location",
     ["android.permission.ACCESS_FINE_LOCATION","android.permission.ACCESS_COARSE_LOCATION"],
     "cordova-plugin-geolocation"),
    ("location-bg",      "ğŸ—º  Background Location", "Location even when app is closed (Android 10+)",
     ["android.permission.ACCESS_BACKGROUND_LOCATION"],
     "cordova-plugin-geolocation"),
    ("internet",         "ğŸŒ Internet",            "Full internet access",
     ["android.permission.INTERNET"],
     None),
    ("network-state",    "ğŸ“¶ Network State",       "Check if device is connected to internet",
     ["android.permission.ACCESS_NETWORK_STATE"],
     "cordova-plugin-network-information"),
    ("wifi-state",       "ğŸ“¡ WiFi State",          "Check WiFi connection status",
     ["android.permission.ACCESS_WIFI_STATE"],
     None),
    ("bluetooth",        "ğŸ”µ Bluetooth",           "Connect to Bluetooth devices",
     ["android.permission.BLUETOOTH","android.permission.BLUETOOTH_ADMIN"],
     None),
    ("bluetooth-scan",   "ğŸ” Bluetooth Scan",      "Scan for nearby Bluetooth devices (Android 12+)",
     ["android.permission.BLUETOOTH_SCAN"],
     None),
    ("nfc",              "ğŸ“² NFC",                 "Near Field Communication",
     ["android.permission.NFC"],
     None),
    ("contacts",         "ğŸ‘¥ Contacts",            "Read & write device contacts",
     ["android.permission.READ_CONTACTS","android.permission.WRITE_CONTACTS"],
     "cordova-plugin-contacts"),
    ("calendar",         "ğŸ“… Calendar",            "Read & write calendar events",
     ["android.permission.READ_CALENDAR","android.permission.WRITE_CALENDAR"],
     None),
    ("sms",              "ğŸ’¬ SMS",                 "Send & receive SMS messages",
     ["android.permission.SEND_SMS","android.permission.RECEIVE_SMS","android.permission.READ_SMS"],
     None),
    ("phone-state",      "ğŸ“ Phone State",         "Read phone number and call state",
     ["android.permission.READ_PHONE_STATE"],
     None),
    ("notifications",    "ğŸ”” Notifications",       "Post local notifications (Android 13+)",
     ["android.permission.POST_NOTIFICATIONS"],
     "cordova-plugin-local-notification"),
    ("vibrate",          "ğŸ“³ Vibrate",             "Vibrate the device",
     ["android.permission.VIBRATE"],
     "cordova-plugin-vibration"),
    ("sensors",          "â¤  Body Sensors",        "Access heart rate and body sensors",
     ["android.permission.BODY_SENSORS"],
     None),
    ("activity",         "ğŸƒ Activity",            "Detect walking/running (Android 10+)",
     ["android.permission.ACTIVITY_RECOGNITION"],
     None),
    ("wake-lock",        "ğŸ’¡ Wake Lock",           "Prevent screen from turning off",
     ["android.permission.WAKE_LOCK"],
     None),
    ("flashlight",       "ğŸ”¦ Flashlight",          "Control the camera flashlight",
     ["android.permission.FLASHLIGHT"],
     None),
    ("biometric",        "ğŸ” Biometric",           "Fingerprint & face authentication",
     ["android.permission.USE_BIOMETRIC","android.permission.USE_FINGERPRINT"],
     None),
    ("install-packages", "ğŸ“¦ Install Packages",    "Install other APK files",
     ["android.permission.REQUEST_INSTALL_PACKAGES"],
     None),
]

# â”€â”€ Terminal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def getch():
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        tty.setraw(fd)
        ch = sys.stdin.read(1)
        if ch == '\x1b':
            ch2 = sys.stdin.read(1)
            if ch2 == '[':
                ch3 = sys.stdin.read(1)
                return f'\x1b[{ch3}'
            return '\x1b'
        return ch
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)

def hide_cursor(): sys.stdout.write('\x1b[?25l'); sys.stdout.flush()
def show_cursor(): sys.stdout.write('\x1b[?25h'); sys.stdout.flush()

def redraw(lines_to_erase, new_lines):
    """Go up N lines, clear to end of screen, print new content."""
    if lines_to_erase > 0:
        sys.stdout.write(f'\x1b[{lines_to_erase}A')  # cursor up
    sys.stdout.write('\x1b[J')                        # clear from cursor to end
    sys.stdout.write('\n'.join(new_lines))
    sys.stdout.write('\n')
    sys.stdout.flush()

def prompt_input(question, default=None):
    hint = f" {clr(f'[{default}]', C.DIM)}" if default else ""
    val  = input(f"  {clr('â†’', C.CYAN, C.BOLD)} {clr(question, C.BOLD)}{hint}: ").strip()
    return val if val else default

# â”€â”€ Permissions selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def permissions_selector():
    selected   = [False] * len(PERMISSIONS)
    cursor     = 0
    visible    = min(len(PERMISSIONS), 14)
    scroll_top = 0

    def build_lines():
        out = []
        out.append(clr("  â”Œâ”€ Select Permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”", C.CYAN, C.BOLD))
        out.append(clr("  â”‚  â†‘â†“ move  SPACE toggle  A all  N none  ENTER confirm             â”‚", C.DIM))
        out.append(clr("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜", C.CYAN, C.BOLD))

        for i in range(scroll_top, min(scroll_top + visible, len(PERMISSIONS))):
            _, label, desc, _, _ = PERMISSIONS[i]
            box = clr("[âœ“]", C.GREEN, C.BOLD) if selected[i] else clr("[ ]", C.DIM)
            if i == cursor:
                out.append(clr(f"  â–¶ {box} {label:<24}", C.CYAN, C.BOLD) + clr(desc, C.CYAN))
            else:
                out.append(f"    {box} {clr(label, C.BOLD):<24}{clr(desc, C.DIM)}")

        total   = len(PERMISSIONS)
        end_idx = min(scroll_top + visible, total)
        if total > visible:
            pct = int(scroll_top / max(1, total - visible) * 100)
            out.append(clr(f"  {scroll_top+1}â€“{end_idx} of {total}  ({pct}%)", C.DIM))
        else:
            out.append("")

        count = sum(selected)
        out.append(clr(f"  âœ” {count} permission(s) selected", C.YELLOW, C.BOLD))
        return out

    hide_cursor()
    current_lines = build_lines()
    print('\n'.join(current_lines))

    try:
        while True:
            ch = getch()
            prev_len = len(current_lines)

            if ch == '\x1b[A':        # Up arrow
                cursor = max(0, cursor - 1)
                if cursor < scroll_top:
                    scroll_top = cursor

            elif ch == '\x1b[B':      # Down arrow
                cursor = min(len(PERMISSIONS) - 1, cursor + 1)
                if cursor >= scroll_top + visible:
                    scroll_top = cursor - visible + 1

            elif ch == ' ':           # Toggle
                selected[cursor] = not selected[cursor]

            elif ch in ('a', 'A'):    # All
                selected = [True]  * len(PERMISSIONS)

            elif ch in ('n', 'N'):    # None
                selected = [False] * len(PERMISSIONS)

            elif ch in ('\r', '\n'):  # Confirm
                break

            elif ch in ('q', '\x1b'): # Quit
                selected = [False] * len(PERMISSIONS)
                break

            current_lines = build_lines()
            redraw(prev_len, current_lines)

    finally:
        show_cursor()

    return [PERMISSIONS[i] for i, s in enumerate(selected) if s]

# â”€â”€ Cordova helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def run_command(command, cwd=None, env=None):
    try:
        process = subprocess.Popen(
            command, stdout=subprocess.PIPE, stderr=subprocess.STDOUT,
            shell=True, text=True, cwd=cwd, env=env
        )
        for line in process.stdout:
            print(line, end='')
        process.wait()
        return process.returncode == 0
    except Exception as e:
        err(str(e))

def add_permissions_to_config(root_elem, android_perms):
    ns = "http://schemas.android.com/apk/res/android"
    platform_elem = None
    for child in root_elem:
        if child.tag == "platform" and child.get("name") == "android":
            platform_elem = child
            break
    if platform_elem is None:
        platform_elem = ET.SubElement(root_elem, "platform", {"name": "android"})
    for perm in android_perms:
        e = ET.SubElement(platform_elem, "uses-permission")
        e.set(f"{{{ns}}}name", perm)

def inject_permissions_into_manifest(project_path, android_perms):
    manifest = project_path / "platforms" / "android" / "app" / "src" / "main" / "AndroidManifest.xml"
    if not manifest.exists():
        warn("AndroidManifest.xml not found â€” skipping.")
        return
    ET.register_namespace('android', 'http://schemas.android.com/apk/res/android')
    tree = ET.parse(manifest)
    root = tree.getroot()
    ns   = "http://schemas.android.com/apk/res/android"
    existing = {e.get(f"{{{ns}}}name") for e in root.findall("uses-permission")}
    added = 0
    for perm in android_perms:
        if perm not in existing:
            e = ET.SubElement(root, "uses-permission")
            e.set(f"{{{ns}}}name", perm)
            added += 1
    if added:
        tree.write(manifest, encoding='utf-8', xml_declaration=True)
        ok(f"Injected {added} permission(s) into AndroidManifest.xml")

# â”€â”€ Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def run_wizard(source_path):
    print(clr("\n  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—", C.CYAN, C.BOLD))
    print(clr("  â•‘       html2apk-cli  â€”  Setup Wizard      â•‘", C.CYAN, C.BOLD))
    print(clr("  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n", C.CYAN, C.BOLD))

    folder_name = source_path.name.replace("-"," ").replace("_"," ").title()
    pkg_default = f"com.example.{source_path.name.lower().replace('-','').replace('_','')}"

    app_name = prompt_input("App name",   default=folder_name)
    app_id   = prompt_input("Package ID", default=pkg_default)
    version  = prompt_input("Version",    default="1.0.0")

    print(f"\n  {clr('â†’', C.CYAN, C.BOLD)} {clr('Icon path (PNG)', C.BOLD)} {clr('[leave blank for default]', C.DIM)}: ", end="", flush=True)
    icon_raw  = input().strip()
    icon_path = Path(icon_raw).resolve() if icon_raw else None
    if icon_path and not icon_path.exists():
        warn(f"Icon '{icon_raw}' not found â€” using default.")
        icon_path = None

    print(f"\n  {clr('âš™  Select permissions for your app:', C.BOLD, C.YELLOW)}\n")
    chosen_perms = permissions_selector()

    print(f"\n  {clr('Build type:', C.BOLD)}")
    print(f"    {clr('[1]', C.CYAN)} Debug  {clr('(default)', C.DIM)}")
    print(f"    {clr('[2]', C.CYAN)} Release")
    bt = input(f"\n  {clr('â†’', C.CYAN, C.BOLD)} Choice [1]: ").strip()
    release = (bt == "2")

    return {
        "name":    app_name,
        "id":      app_id,
        "version": version,
        "icon":    icon_path,
        "release": release,
        "perms":   chosen_perms,
    }

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def main():
    parser = argparse.ArgumentParser(
        description="html2apk-cli: Convert web projects to Android APK with interactive wizard.",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  html2apk-cli ./my-web-app
  html2apk-cli ./my-app --no-wizard --name "My App" --id com.me.app --permissions storage camera
        """
    )
    parser.add_argument("source",        help="Path to the project folder")
    parser.add_argument("--output",      default="dist-apk")
    parser.add_argument("--java",        help="Path to JAVA_HOME")
    parser.add_argument("--skip-build",  action="store_true")
    parser.add_argument("--no-wizard",   action="store_true")
    parser.add_argument("--name",        default=None)
    parser.add_argument("--id",          default=None)
    parser.add_argument("--version",     default="1.0.0")
    parser.add_argument("--icon",        default=None)
    parser.add_argument("--release",     action="store_true")
    parser.add_argument("--permissions", nargs="+", metavar="PERM")

    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit(0)

    args = parser.parse_args()
    source_path = Path(args.source).resolve()
    if not source_path.is_dir():
        err(f"'{args.source}' is not a directory.")

    if args.no_wizard:
        folder_name = source_path.name.replace("-"," ").replace("_"," ").title()
        keys_map    = {p[0]: p for p in PERMISSIONS}
        perms       = []
        if args.permissions:
            for k in args.permissions:
                if k in keys_map: perms.append(keys_map[k])
                else: warn(f"Unknown permission '{k}' â€” skipped.")
        config = {
            "name":    args.name    or folder_name,
            "id":      args.id      or f"com.example.{source_path.name.lower().replace('-','').replace('_','')}",
            "version": args.version,
            "icon":    Path(args.icon).resolve() if args.icon else None,
            "release": args.release,
            "perms":   perms,
        }
    else:
        config = run_wizard(source_path)

    # Summary
    print(clr("\n  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€", C.DIM))
    print(clr("  Build Summary", C.BOLD, C.HEADER))
    print(clr("  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€", C.DIM))
    print(f"  App Name   : {clr(config['name'], C.BOLD)}")
    print(f"  Package    : {clr(config['id'], C.BOLD)}")
    print(f"  Version    : {clr(config['version'], C.BOLD)}")
    print(f"  Icon       : {clr(str(config['icon']) if config['icon'] else 'Default', C.BOLD)}")
    print(f"  Build      : {clr('Release' if config['release'] else 'Debug', C.BOLD)}")
    perm_labels = ", ".join(p[1].split(" ",1)[1].strip() for p in config["perms"]) if config["perms"] else "None"
    print(f"  Permissions: {clr(perm_labels, C.BOLD)}")
    print(clr("  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n", C.DIM))

    confirm = input(f"  {clr('â†’ Start build? [Y/n]: ', C.CYAN, C.BOLD)}").strip().lower()
    if confirm == 'n':
        print("  Cancelled.")
        sys.exit(0)
    print()

    # Environment
    custom_env = os.environ.copy()
    if "ANDROID_HOME" not in custom_env:
        sdk = Path.home() / "Android" / "Sdk"
        if sdk.exists():
            custom_env["ANDROID_HOME"] = str(sdk)
            custom_env["PATH"] += f":{sdk}/platform-tools:{sdk}/cmdline-tools/latest/bin"

    if args.java:
        custom_env["JAVA_HOME"] = args.java
        custom_env["PATH"] = f"{os.path.join(args.java,'bin')}:{custom_env['PATH']}"
    elif "JAVA_HOME" not in custom_env:
        java17 = "/usr/lib/jvm/java-17-openjdk-amd64"
        if os.path.exists(java17):
            log("Auto-selecting Java 17...", C.CYAN)
            custom_env["JAVA_HOME"] = java17
            custom_env["PATH"] = f"{java17}/bin:{custom_env['PATH']}"

    # Node build
    actual_assets = source_path
    pkg_json = source_path / "package.json"
    if pkg_json.exists() and not args.skip_build:
        log("Node.js project detected...", C.CYAN)
        try:
            with open(pkg_json) as f:
                pkg = json.load(f)
            if "scripts" in pkg and "build" in pkg["scripts"]:
                log("npm install...")
                if not run_command("npm install", cwd=source_path): err("npm install failed.")
                log("npm run build...")
                if not run_command("npm run build", cwd=source_path): err("npm run build failed.")
                for d in ["dist","build","out","public","output"]:
                    c = source_path / d
                    if c.is_dir() and (c / "index.html").exists():
                        actual_assets = c
                        ok(f"Build output: {d}/")
                        break
                else:
                    err("No build output with index.html found.")
            else:
                log("No build script â€” using folder directly.", C.YELLOW)
        except Exception as e:
            warn(f"package.json error: {e}")

    if not (actual_assets / "index.html").exists():
        err(f"No index.html in {actual_assets}")

    # Cordova
    project_name = "cordova_project"
    project_path = Path.cwd() / project_name
    output_path  = Path(args.output).resolve()

    if project_path.exists():
        log("Cleaning old build...")
        shutil.rmtree(project_path)

    log("Creating Cordova project...")
    if not run_command(f'cordova create "{project_name}" "{config["id"]}" "{config["name"]}"', env=custom_env):
        err("Failed to create Cordova project.")

    log("Copying web assets...")
    www = project_path / "www"
    for item in www.iterdir():
        shutil.rmtree(item) if item.is_dir() else item.unlink()
    for item in actual_assets.iterdir():
        if item.name == project_name: continue
        shutil.copytree(item, www / item.name) if item.is_dir() else shutil.copy2(item, www / item.name)

    log("Configuring config.xml...")
    config_xml = project_path / "config.xml"
    ET.register_namespace('', "http://www.w3.org/ns/widgets")
    ET.register_namespace('android', "http://schemas.android.com/apk/res/android")
    tree = ET.parse(config_xml)
    root = tree.getroot()
    root.set('version', config["version"])

    if config["icon"]:
        shutil.copy2(config["icon"], project_path / "icon.png")
        ET.SubElement(root, 'icon', {'src': 'icon.png'})
        ok("Icon set.")

    all_android_perms = []
    all_plugins       = []
    for _, _, _, android_perms, plugin in config["perms"]:
        all_android_perms.extend(android_perms)
        if plugin: all_plugins.append(plugin)

    if all_android_perms:
        add_permissions_to_config(root, all_android_perms)

    tree.write(config_xml, encoding='utf-8', xml_declaration=True)

    log("Adding Android platform...")
    if not run_command("cordova platform add android", cwd=project_path, env=custom_env):
        err("Failed to add Android platform.")

    for plugin in list(set(all_plugins)):
        log(f"Installing plugin: {plugin}...", C.CYAN)
        if not run_command(f"cordova plugin add {plugin}", cwd=project_path, env=custom_env):
            warn(f"Plugin '{plugin}' failed â€” continuing.")

    if all_android_perms:
        inject_permissions_into_manifest(project_path, all_android_perms)

    build_type = "--release" if config["release"] else "--debug"
    log("Building APK...", C.CYAN)
    if not run_command(f"cordova build android {build_type}", cwd=project_path, env=custom_env):
        err("Build failed.")

    mode    = "release" if config["release"] else "debug"
    apk_dir = project_path / "platforms" / "android" / "app" / "build" / "outputs" / "apk" / mode
    apks    = list(apk_dir.glob("*.apk"))
    if not apks: err("APK not found after build.")

    output_path.mkdir(parents=True, exist_ok=True)
    final_name = f"{config['name'].replace(' ','_')}_{mode}.apk"
    shutil.copy2(apks[0], output_path / final_name)

    print(clr("\n  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—", C.GREEN, C.BOLD))
    print(clr("  â•‘          âœ…  Build Successful!            â•‘", C.GREEN, C.BOLD))
    print(clr("  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•", C.GREEN, C.BOLD))
    print(f"\n  {clr('APK:', C.BOLD)} {clr(str(output_path / final_name), C.CYAN)}")
    if all_android_perms:
        short = ", ".join(p.split(".")[-1] for p in set(all_android_perms))
        print(f"  {clr('Permissions:', C.BOLD)} {short}")
    print()

if __name__ == "__main__":
    main()
